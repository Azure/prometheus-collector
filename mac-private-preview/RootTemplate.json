{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "monitoringAccountName": {
            "type": "string"
        },
        "monitoringAccountLocation": {
            "type": "string",
            "defaultValue": "",
            "allowedValues": [
                "eastus",
                "eastus2",
                "westeurope",
                "eastus2euap"
            ]
        },
        "roleDefinitionName": {
            "type": "string",
            "defaultValue": "[guid(resourceGroup().id)]"
            // [guid(subscription().subscriptionId)]
            // "[guid(resourceGroup().id)]"
        },
        "dceName": {
            "type": "string",
            "defaultValue": "[concat('dce-', parameters('monitoringAccountName'), '-', uniqueString(parameters('targetAKSResource')))]"
        },
        "dcrName": {
            "type": "string",
            "defaultValue": "[concat('dcr-', parameters('monitoringAccountName'), '-', uniqueString(parameters('targetAKSResource')))]"
        },
        "dcraName": {
            "type": "string",
            "defaultValue": "[concat('dcra-', parameters('monitoringAccountName'), '-', uniqueString(parameters('targetAKSResource')))]"
        },
        "targetAKSResource": {
            "type": "string"
        },
        "AKSSubId": {
            "type": "string"
        },
        "AKSRg": {
            "type": "string"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Authorization/roleDefinitions",
            "apiVersion": "2018-01-01-preview",
            "name": "[parameters('roleDefinitionName')]",
            "location": "[parameters('monitoringAccountLocation')]",
            "properties": {
                "assignableScopes": [
                    "[resourceGroup().id]"
                ],
                "description": "Custom role Definition to allow users to query data stored in a Monitoring Account",
                "permissions": [
                    {
                        "actions": [
                            "*/read"
                        ],
                        "dataActions": [
                            "*/read",
                            "*/write"
                        ]
                    }
                ],
                // To do figure out unique names for role
                "roleName": "Monitoring Data Reader MAC2",
                "type": "CustomRole"
            }
        },
        {
            "type": "microsoft.monitor/accounts",
            "apiVersion": "2021-06-03-preview",
            "name": "[parameters('monitoringAccountName')]",
            "location": "[parameters('monitoringAccountLocation')]"
        },
        {
            "type": "Microsoft.Insights/dataCollectionEndpoints",
            "apiVersion": "2021-09-01-preview",
            "name": "[parameters('dceName')]",
            "location": "[parameters('monitoringAccountLocation')]",
            "kind": "Linux",
            "properties": {}
        },
        {
            "type": "Microsoft.Insights/dataCollectionRules",
            "apiVersion": "2021-09-01-preview",
            "name": "[parameters('dcrName')]",
            "location": "[parameters('monitoringAccountLocation')]",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints/', parameters('dceName'))]",
                "[resourceId('Microsoft.Monitor/Accounts/', parameters('monitoringAccountName'))]"
            ],
            "tags": {
                "tagName1": "tagValue1",
                "tagName2": "tagValue2"
            },
            "kind": "Linux",
            "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints/', parameters('dceName'))]",
                "dataFlows": [
                    {
                        "destinations": [ "MonitoringAccount1" ],
                        "streams": [ "Microsoft-PrometheusMetrics" ]
                    }
                ],
                "dataSources": {
                    "prometheusForwarder": [
                        {
                            "name": "PrometheusDataSource",
                            "streams": [
                                "Microsoft-PrometheusMetrics"
                            ],
                            "labelIncludeFilter": {
                                // "microsoft_metrics_include_label": "MonitoringData"
                            }
                        }
                    ]
                },
                "description": "DCR description",
                "destinations": {
                    "monitoringAccounts": [
                        {
                            "accountResourceId": "[resourceId('Microsoft.Monitor/Accounts/', parameters('monitoringAccountName'))]",
                            "name": "MonitoringAccount1"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "nestedDCRADeployment",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionRules/', parameters('dcrName'))]"
            ],
            "subscriptionId": "[parameters('AKSSubId')]",
            "resourceGroup": "[parameters('AKSRg')]",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "dcrId": {
                        "value": "[resourceId('Microsoft.Insights/dataCollectionRules/', parameters('dcrName'))]"
                    },
                    "dcraName": {
                        "value": "[parameters('dcraName')]"
                    },
                    "targetAKSResource": {
                        "value": "[parameters('targetAKSResource')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "dcrId": {
                            "type": "string"
                        },
                        "dcraName": {
                            "type": "string"
                        },
                        "targetAKSResource": {
                            "type": "string"
                        }
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Insights/dataCollectionRuleAssociations",
                            "apiVersion": "2021-09-01-preview",
                            "name": "[parameters('dcraName')]",
                            "scope": "[parameters('targetAKSResource')]",
                            "properties": {
                                "dataCollectionRuleId": "[parameters('dcrId')]",
                                "description": "Data collection association between DCR, DCE and target AKS resource"
                            }
                        }
                    ]
                }
            }
        }
    ]
}