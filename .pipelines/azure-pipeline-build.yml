trigger:
  branches:
    include:
    - main
    - esrpUpdateSvcConnectionTestBranch

pr:
  autoCancel: true
  branches:
    include:
    - main

variables:
  HELM_CHART_NAME: 'prometheus-collector'
  ARC_HELM_CHART_NAME: 'ama-metrics-arc'
  ACR_REGISTRY: 'containerinsightsprod.azurecr.io'
  ACR_REPOSITORY: '/public/azuremonitor/containerinsights/cidev/prometheus-collector/images'
  ACR_REPOSITORY_HELM: '/public/azuremonitor/containerinsights/cidev'
  MCR_REGISTRY: 'mcr.microsoft.com'
  MCR_REPOSITORY: '/azuremonitor/containerinsights/cidev/prometheus-collector/images'
  MCR_REPOSITORY_HELM: '/azuremonitor/containerinsights/cidev/prometheus-collector'
  MCR_REPOSITORY_HELM_DEPENDENCIES: '/azuremonitor/containerinsights/cidev'
  KUBE_STATE_METRICS_IMAGE: 'mcr.microsoft.com/oss/kubernetes/kube-state-metrics:v2.9.2'
  NODE_EXPORTER_IMAGE: 'mcr.microsoft.com/oss/prometheus/node-exporter:v1.6.0'
  IS_PR: $[eq(variables['Build.Reason'], 'PullRequest')]
  IS_MAIN_BRANCH: $[eq(variables['Build.SourceBranchName'], 'main')]

stages:
- stage: Build
  jobs:
  - job: Image_Tags_and_Ev2_Artifacts
    displayName: "Build: Set image tags and publish Ev2 artifacts"
    pool:
      name: Azure-Pipelines-CI-Test-EO
    variables:
      skipComponentGovernanceDetection: true
    steps:
      - checkout: self
        submodules: true
      - bash: |
          if [ $(IS_PR) == "True" ]; then
            BRANCH_NAME=$(System.PullRequest.SourceBranch)
          else
            BRANCH_NAME=$(Build.SourceBranch)
            BRANCH_NAME=${BRANCH_NAME#refs/heads/}
          fi
          BRANCH_NAME=$(echo $BRANCH_NAME | tr / - | tr . - | tr _ - | cut -c1-90)
          COMMIT_SHA=$(echo $(Build.SourceVersion) | cut -b -8)
          DATE=$(TZ=America/Los_Angeles date +%m-%d-%Y)
          VERSION=$(cat $(Build.SourcesDirectory)/otelcollector/VERSION)
          SEMVER=$VERSION-$BRANCH_NAME-$DATE-$COMMIT_SHA

          LINUX_IMAGE_TAG=$SEMVER
          # Truncating to 128 characters as it is required by docker
          LINUX_IMAGE_TAG=$(echo "${LINUX_IMAGE_TAG}" | cut -c1-128)
                  
          #Truncating this to 124 to add the cfg suffix
          LINUX_IMAGE_TAG_PREFIX=$(echo "${LINUX_IMAGE_TAG}" | cut -c1-124)
          LINUX_CONFIG_READER_IMAGE_TAG=$LINUX_IMAGE_TAG_PREFIX-cfg
          LINUX_CCP_IMAGE_TAG=$LINUX_IMAGE_TAG_PREFIX-ccp
          LINUX_CCP_IMAGE_TAG=$LINUX_IMAGE_TAG_PREFIX-ccp

          #Truncating this to 113 to add the ref app suffices
          LINUX_REF_APP_IMAGE_TAG_PREFIX=$(echo "${LINUX_IMAGE_TAG}" | cut -c1-113)
          LINUX_REF_APP_GOLANG_IMAGE_TAG=$LINUX_REF_APP_IMAGE_TAG_PREFIX-ref-app-golang
          LINUX_REF_APP_PYTHON_IMAGE_TAG=$LINUX_REF_APP_IMAGE_TAG_PREFIX-ref-app-python

          # Truncating to 115 characters as it is required by docker (4 characters used in -win and 9 characters used in -ltsc2019/-ltsc2022)
          WINDOWS_IMAGE_TAG_PREFIX=$(echo "${LINUX_IMAGE_TAG}" | cut -c1-115)
          WINDOWS_IMAGE_TAG=$WINDOWS_IMAGE_TAG_PREFIX-win


          #Truncating this to 112 characters to add the targetallocator suffix
          TARGET_ALLOCATOR_IMAGE_TAG_PREFIX=$(echo "${LINUX_IMAGE_TAG}" | cut -c1-112)
          TARGET_ALLOCATOR_IMAGE_TAG=$TARGET_ALLOCATOR_IMAGE_TAG_PREFIX-targetallocator

          #Truncating this to 113 to add the ref app suffices
          WIN_REF_APP_IMAGE_TAG_PREFIX=$(echo "${LINUX_IMAGE_TAG}" | cut -c1-107)
          WIN_REF_APP_GOLANG_IMAGE_TAG=$WIN_REF_APP_IMAGE_TAG_PREFIX-win-ref-app-golang
          WIN_REF_APP_PYTHON_IMAGE_TAG=$WIN_REF_APP_IMAGE_TAG_PREFIX-win-ref-app-python

          # Truncating to 119 characters as it is required by docker (9 characters used in -ltsc2019/-ltsc2022)
          WINDOWS_2019_BASE_IMAGE_VERSION=ltsc2019
          WINDOWS_2022_BASE_IMAGE_VERSION=ltsc2022

          LINUX_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$LINUX_IMAGE_TAG
          TARGET_ALLOCATOR_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$TARGET_ALLOCATOR_IMAGE_TAG
          LINUX_CONFIG_READER_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$LINUX_CONFIG_READER_IMAGE_TAG
          LINUX_CCP_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$LINUX_CCP_IMAGE_TAG
          WINDOWS_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$WINDOWS_IMAGE_TAG
          HELM_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY_HELM/$HELM_CHART_NAME:$SEMVER
          ARC_HELM_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY_HELM/$ARC_HELM_CHART_NAME:$SEMVER
          LINUX_REF_APP_GOLANG_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$LINUX_REF_APP_GOLANG_IMAGE_TAG
          LINUX_REF_APP_PYTHON_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$LINUX_REF_APP_PYTHON_IMAGE_TAG
          WINDOWS_REF_APP_GOLANG_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$WIN_REF_APP_GOLANG_IMAGE_TAG
          WINDOWS_REF_APP_PYTHON_FULL_IMAGE_NAME=$ACR_REGISTRY$ACR_REPOSITORY:$WIN_REF_APP_PYTHON_IMAGE_TAG

          echo "##vso[build.updatebuildnumber]$SEMVER"
          echo "##vso[task.setvariable variable=SEMVER;isOutput=true]$SEMVER"
          echo "##vso[task.setvariable variable=LINUX_FULL_IMAGE_NAME;isOutput=true]$LINUX_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=TARGET_ALLOCATOR_IMAGE_TAG;isOutput=true]$TARGET_ALLOCATOR_IMAGE_TAG"
          echo "##vso[task.setvariable variable=LINUX_CONFIG_READER_IMAGE_TAG;isOutput=true]$LINUX_CONFIG_READER_IMAGE_TAG"
          echo "##vso[task.setvariable variable=TARGET_ALLOCATOR_FULL_IMAGE_NAME;isOutput=true]$TARGET_ALLOCATOR_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=LINUX_CONFIG_READER_FULL_IMAGE_NAME;isOutput=true]$LINUX_CONFIG_READER_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=LINUX_CCP_FULL_IMAGE_NAME;isOutput=true]$LINUX_CCP_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=WINDOWS_FULL_IMAGE_NAME;isOutput=true]$WINDOWS_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=LINUX_REF_APP_GOLANG_FULL_IMAGE_NAME;isOutput=true]$LINUX_REF_APP_GOLANG_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=LINUX_REF_APP_PYTHON_FULL_IMAGE_NAME;isOutput=true]$LINUX_REF_APP_PYTHON_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=WINDOWS_REF_APP_GOLANG_FULL_IMAGE_NAME;isOutput=true]$WINDOWS_REF_APP_GOLANG_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=WINDOWS_REF_APP_PYTHON_FULL_IMAGE_NAME;isOutput=true]$WINDOWS_REF_APP_PYTHON_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=WINDOWS_IMAGE_TAG;isOutput=true]$WINDOWS_IMAGE_TAG"
          echo "##vso[task.setvariable variable=WINDOWS_2019_BASE_IMAGE_VERSION;isOutput=true]$WINDOWS_2019_BASE_IMAGE_VERSION"
          echo "##vso[task.setvariable variable=WINDOWS_2022_BASE_IMAGE_VERSION;isOutput=true]$WINDOWS_2022_BASE_IMAGE_VERSION"
          echo "##vso[task.setvariable variable=HELM_CHART_NAME;isOutput=true]$HELM_CHART_NAME"
          echo "##vso[task.setvariable variable=ARC_HELM_CHART_NAME;isOutput=true]$ARC_HELM_CHART_NAME"
          echo "##vso[task.setvariable variable=HELM_FULL_IMAGE_NAME;isOutput=true]$HELM_FULL_IMAGE_NAME"
          echo "##vso[task.setvariable variable=ARC_HELM_FULL_IMAGE_NAME;isOutput=true]$ARC_HELM_FULL_IMAGE_NAME"
        displayName: 'Build: set image registry, repo, and tags'
        name: setup

      - bash: |
          cd $(Build.SourcesDirectory)/.pipelines/deployment/ServiceGroupRoot/Scripts
          cp ../../../../otelcollector/deploy/chart/prometheus-collector prometheus-collector -r
          cp ../../../../otelcollector/deploy/addon-chart/azure-monitor-metrics-addon ama-metrics-arc -r
          export MCR_REPOSITORY='/azuremonitor/containerinsights/ciprod/prometheus-collector/images'
          export MCR_REPOSITORY_HELM_DEPENDENCIES='/azuremonitor/containerinsights/ciprod'
          export HELM_SEMVER=$SETUP_SEMVER
          export IMAGE_TAG=$SETUP_SEMVER
          export IMAGE_TAG_WINDOWS=$SETUP_WINDOWS_IMAGE_TAG
          env

          envsubst < prometheus-collector/Chart-template.yaml > prometheus-collector/Chart.yaml && envsubst < prometheus-collector/values-template.yaml > prometheus-collector/values.yaml
          export ARC_EXTENSION=true
          export HELM_CHART_NAME=$ARC_HELM_CHART_NAME
          envsubst < ama-metrics-arc/Chart-template.yaml > ama-metrics-arc/Chart.yaml && envsubst < ama-metrics-arc/values-template.yaml > ama-metrics-arc/values.yaml
          tar -czvf ../artifacts.tar.gz pushAgentToAcr.sh pushChartToAcr.sh prometheus-collector ama-metrics-arc

          cd $(Build.ArtifactStagingDirectory)
          cp $(Build.SourcesDirectory)/otelcollector/deploy/addon-chart/azure-monitor-metrics-addon azure-monitor-metrics-addon -r
          export HELM_CHART_NAME="ama-metrics"
          export ARC_EXTENSION=false
          export AKS_REGION="westeurope"
          export AKS_RESOURCE_ID="/subscriptions/9b96ebbd-c57a-42d1-bbe9-b69296e4c7fb/resourceGroups/ci-prod-aks-mac-weu-rg/providers/Microsoft.ContainerService/managedClusters/ci-prod-aks-mac-weu"
          envsubst < azure-monitor-metrics-addon/Chart-template.yaml > azure-monitor-metrics-addon/Chart.yaml && envsubst < azure-monitor-metrics-addon/values-template.yaml > azure-monitor-metrics-addon/values.yaml
        displayName: 'Ev2: package artifacts.tar.gz for prod release'

      - bash: |
          cd $(Build.SourcesDirectory)/.pipelines/deployment/arc-extension-release/ServiceGroupRoot/Scripts
          tar -czvf ../extension-artifacts.tar.gz arcExtensionRelease.sh
        displayName: 'Ev2: package extension-artifacts.tar.gz for prod release'

      - task: CredScan@3
        displayName: "SDL : Run credscan"

      - task: CopyFiles@2
        displayName: "Ev2: copy Ev2 deployment artifacts to staging directory"
        inputs:
          SourceFolder: "$(Build.SourcesDirectory)/.pipelines/deployment"
          Contents: |
            **/*
          TargetFolder: '$(Build.ArtifactStagingDirectory)/deploy'

      - task: PublishBuildArtifacts@1
        displayName: "Ev2: publish Ev2 deployment artifacts"
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: drop


  - job: SDL_Policheck_Scan
    displayName: "SDL: policheck scanning"
    pool:
      name: Azure-Pipelines-Windows-CI-Test-EO
    variables:
      skipComponentGovernanceDetection: true
    steps:
      - checkout: self
        submodules: true

      - task: PoliCheck@2
        displayName: "SDL : Run PoliCheck"
        inputs:
          targetType: 'F'
          targetArgument: '$(Build.SourcesDirectory)'


  - job: SDL_Binary_Scan
    displayName: "SDL: linux binary scanning"
    pool:
      name: Azure-Pipelines-CI-Test-EO
    variables:
      skipComponentGovernanceDetection: true
    steps:
      - checkout: self
        submodules: true

      - task: CodeQL3000Init@0
        displayName: 'SDL: init codeql'

      - task: GoTool@0
        displayName: "Build: specify golang version"
        inputs:
          version: '1.21.5'

      - bash: |
          sudo apt-get install build-essential -y
          make
        workingDirectory: $(Build.SourcesDirectory)/otelcollector/opentelemetry-collector-builder/
        displayName: "SDL: build otelcollector, promconfigvalidator, targetallocator, and fluent-bit plugin for scanning"
        retryCountOnTaskFailure: 1

      - task: BinSkim@4
        displayName: 'SDL: run binskim'
        inputs:
          InputType: 'CommandLine'
          arguments: 'analyze --rich-return-code $(Build.SourcesDirectory)/otelcollector/opentelemetry-collector-builder/otelcollector $(Build.SourcesDirectory)/otelcollector/prom-config-validator-builder/promconfigvalidator $(Build.SourcesDirectory)/otelcollector/otel-allocator/targetallocator $(Build.SourcesDirectory)/otelcollector/fluent-bit/src/out_appinsights.so'
        retryCountOnTaskFailure: 1

      - task: ESLint@1
        displayName: 'Run ESLint'
        inputs:
          Configuration: required
          EnableExclusions: false
        retryCountOnTaskFailure: 1 

      - task: Armory@2
        displayName: 'Run ARMory'
        inputs:
          toolVersion: Latest
          targetDirectory: '$(Build.SourcesDirectory)'
        retryCountOnTaskFailure: 1   

      - task: Gosec@1
        displayName: 'SDL: run gosec'
        inputs:
          targetPattern: 'gosecPattern'
          targetGosecPattern: '$(Build.SourcesDirectory)/otelcollector'
        retryCountOnTaskFailure: 1

      - bash: |
          wget https://github.com/microsoft/DevSkim/releases/download/v0.6.9/DevSkim_linux_0.6.9.zip
          unzip DevSkim_linux_0.6.9.zip
          chmod 775 DevSkim_linux_0.6.9/devskim
          ./DevSkim_linux_0.6.9/devskim analyze $(Build.SourcesDirectory)/otelcollector --ignore-globs **/deploy/dashboard/**,**/react/static/** --severity critical,important
        displayName: 'SDL: run devskim'
        workingDirectory: $(Build.SourcesDirectory)
        retryCountOnTaskFailure: 1

      - bash: |
          sudo gem install brakeman -v 5.4.1
          brakeman $(Build.SourcesDirectory)/otelcollector/configmapparser --force
        displayName: 'SDL: run brakeman'
        retryCountOnTaskFailure: 1

  - job: Linux_Prometheus_Collector
    displayName: "Build: linux prometheus-collector image"
    pool:
      name: Azure-Pipelines-CI-Test-EO
    dependsOn: Image_Tags_and_Ev2_Artifacts
    variables:
      LINUX_FULL_IMAGE_NAME: $[ dependencies.Image_Tags_and_Ev2_Artifacts.outputs['setup.LINUX_FULL_IMAGE_NAME'] ]
    # This is necessary because of: https://github.com/moby/moby/issues/37965
      DOCKER_BUILDKIT: 1
    steps:
      - checkout: self
        submodules: true

      - task: CodeQL3000Init@0
        displayName: 'SDL: init codeql'

      - task: GoTool@0
        displayName: "Build: specify golang version"
        inputs:
          version: '1.20'

      - bash: |
          mkdir -p $(Build.ArtifactStagingDirectory)/linux

          # Necessary due to necessary due to https://stackoverflow.com/questions/60080264/docker-cannot-build-multi-platform-images-with-docker-buildx
          sudo apt-get update && sudo apt-get -y install qemu binfmt-support qemu-user-static
          docker system prune --all -f
          docker images -q --filter "dangling=true" | xargs docker rmi
          docker login containerinsightsprod.azurecr.io -u $(ACR_USERNAME) -p $(ACR_PASSWORD)
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

          docker buildx create --name dockerbuilder
          docker buildx use dockerbuilder
          docker buildx build . --platform=linux/amd64,linux/arm64 --file ./build/linux/Dockerfile -t $(LINUX_FULL_IMAGE_NAME) --metadata-file $(Build.ArtifactStagingDirectory)/linux/metadata.json --push # --cache-to type=registry,ref=$(ACR_REGISTRY)$(ACR_REPOSITORY)/cache:prometheuscollector,mode=max --cache-from type=registry,ref=$(ACR_REGISTRY)$(ACR_REPOSITORY)/cache:prometheuscollector
          docker pull $(LINUX_FULL_IMAGE_NAME)
          docker system prune --all -f
        workingDirectory: $(Build.SourcesDirectory)/otelcollector/
        displayName: "Build: build and push image to dev ACR"

      - bash: |
          MEDIA_TYPE=$(docker manifest inspect -v $(LINUX_FULL_IMAGE_NAME) | jq '.Descriptor.mediaType')
          DIGEST=$(docker manifest inspect -v $(LINUX_FULL_IMAGE_NAME) | jq '.Descriptor.digest')
          SIZE=$(docker manifest inspect -v $(LINUX_FULL_IMAGE_NAME) | jq '.Descriptor.size')
          cat <<EOF >>$(Build.ArtifactStagingDirectory)/linux/payload.json
          {"targetArtifact":{"mediaType":$MEDIA_TYPE,"digest":$DIGEST,"size":$SIZE}}
          EOF
        workingDirectory: $(Build.SourcesDirectory)/otelcollector/
        displayName: "Build: Set values in payload.json for signing"
        condition: succeeded()

      - task: EsrpCodeSigning@5
        inputs:
          ConnectedServiceName: 'ESRPServiceConnectionPrometheus'
          AppRegistrationClientId: '73f8d5f9-b507-497f-b698-4ed00fcba5a3'
          AppRegistrationTenantId: '72f988bf-86f1-41af-91ab-2d7cd011db47'
          AuthAKVName: 'ESRPPrometheusKVProd'
          AuthCertName: 'ESRPReqPrometheusProdCert'
          AuthSignCertName: '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'
          FolderPath: '$(Build.ArtifactStagingDirectory)/linux/'
          Pattern: '*.json'
          signConfigType: 'inlineSignParams'
          inlineOperation: |
            [
                          {
                              "keyCode": "CP-469451",
                              "operationSetCode": "NotaryCoseSign",
                              "parameters": [
                                {
                                  "parameterName": "CoseFlags",
                                  "parameterValue": "chainunprotected"
                                }
                              ],
                              "toolName": "sign",
                              "toolVersion": "1.0"
                          }
            ]
          SessionTimeout: '60'
          MaxConcurrency: '50'
          MaxRetryAttempts: '5'
          PendingAnalysisWaitTimeoutMinutes: '5'

      - bash: |
          set -euxo pipefail
          curl -LO "https://github.com/oras-project/oras/releases/download/v1.0.0/oras_1.0.0_linux_amd64.tar.gz"
          mkdir -p oras-install/
          tar -zxf oras_1.0.0_*.tar.gz -C oras-install/
          sudo mv oras-install/oras /usr/local/bin/
          rm -rf oras_1.0.0_*.tar.gz oras-install/
          oras attach $(LINUX_FULL_IMAGE_NAME) \
            --artifact-type 'application/vnd.cncf.notary.signature' \
            ./payload.json:application/cose \
            -a "io.cncf.notary.x509chain.thumbprint#S256=[\"79E6A702361E1F60DAA84AEEC4CBF6F6420DE6BA\"]"
          oras attach $(LINUX_FULL_IMAGE_NAME) \
            --artifact-type 'application/vnd.microsoft.artifact.lifecycle' \
            --annotation "vnd.microsoft.artifact.lifecycle.end-of-life.date=$(date -u -d '-1 hour' +"%Y-%m-%dT%H:%M:%SZ")"
        workingDirectory: $(Build.ArtifactStagingDirectory)/linux/
        displayName: "ORAS Push Artifacts in $(Build.ArtifactStagingDirectory)/linux/"
        condition: succeeded()

      - bash: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy image --ignore-unfixed --no-progress --severity HIGH,CRITICAL,MEDIUM --exit-code 1 $(LINUX_FULL_IMAGE_NAME)
          if [ $? -ne 0 ]; then
            exit 1
          fi
          trivy image --ignore-unfixed --no-progress --severity HIGH,CRITICAL,MEDIUM --exit-code 1 $(KUBE_STATE_METRICS_IMAGE)
          if [ $? -ne 0 ]; then
            exit 1
          fi
          trivy image --ignore-unfixed --no-progress --severity HIGH,CRITICAL,MEDIUM --exit-code 1 $(NODE_EXPORTER_IMAGE)
          if [ $? -ne 0 ]; then
            exit 1
          fi
        workingDirectory: $(Build.SourcesDirectory)
        displayName: "Build: run trivy scan"

      - task: CodeQL3000Finalize@0
        displayName: 'SDL: run codeql'

      - task: ComponentGovernanceComponentDetection@0
        displayName: "SDL: run component governance"
        inputs:
          scanType: 'Register'
          verbosity: 'Verbose'
          dockerImagesToScan: '$(LINUX_FULL_IMAGE_NAME)'
          alertWarningLevel: 'High'
          sourceScanPath: '$(Build.SourcesDirectory)/otelcollector'
          ignoreDirectories: '$(Build.SourcesDirectory)/mixins,$(Build.SourcesDirectory)/tools,$(Build.SourcesDirectory)/otelcollector/react'

      - task: AzureArtifacts.manifest-generator-task.manifest-generator-task.ManifestGeneratorTask@0
        displayName: "Ev2: Generate image artifacts"
        condition: and(succeeded(), and(eq(variables.IS_PR, false), eq(variables.IS_MAIN_BRANCH, true)))
        inputs:
          BuildDropPath: '$(Build.ArtifactStagingDirectory)/linux'
          DockerImagesToScan: '$(LINUX_FULL_IMAGE_NAME)'

      - task: SdtReport@2
        displayName: 'SDL: generate report'
        inputs:
          GdnExportAllTools: false
          GdnExportGdnToolBinSkim: true
          GdnExportGdnToolBinSkimSeverity: 'Note'
          GdnExportGdnToolGosec: true
          GdnExportGdnToolGosecSeverity: 'Note'
          GdnExportGdnToolSemmle: true
          GdnExportGdnToolSemmleSeverity: 'Note'

      - task: PublishSecurityAnalysisLogs@3
        displayName: 'SDL: publish report'
        inputs:
          ArtifactName: 'CodeAnalysisLogs'
          ArtifactType: 'Container'
          PublishProcessedResults: true
          AllTools: true
          ToolLogsNotFoundAction: 'Standard'

      - task: PublishBuildArtifacts@1
        displayName: "Ev2: Publish image artifacts"
        condition: and(succeeded(), and(eq(variables.IS_PR, false), eq(variables.IS_MAIN_BRANCH, true)))
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: drop

      - task: PostAnalysis@2
        displayName: 'SDL: Post-Build Analysis'
        inputs:
          GdnBreakAllTools: false
          GdnBreakGdnToolBinSkim: true
          GdnBreakGdnToolBinSkimSeverity: 'Warning'
          GdnBreakGdnToolGosec: true
          GdnBreakGdnToolGosecSeverity: 'Warning'
          GdnBreakGdnToolSemmle: true
          GdnBreakGdnToolSemmleSeverity: 'Warning'
