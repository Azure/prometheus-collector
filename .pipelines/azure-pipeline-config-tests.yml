# schedule to run everyday
schedules:
- cron: '0 6 * * *'
  displayName: Daily config processing test run
  branches:
    include:
    - main
parameters:
- name: subscriptionName
  displayName: 'Subscription Name'
  type: string
  default: 'ContainerInsights_Build_Subscription'
- name: subscriptionID
  displayName: 'Subscription ID'
  type: string
  default: '9b96ebbd-c57a-42d1-bbe9-b69296e4c7fb'
- name: clusterName
  displayName: 'AKS Cluster Name'
  type: string
  default: 'ci-dev-aks-tests'
- name: clusterResourceGroup
  displayName: 'AKS Cluster Resource Group'
  type: string
  default: 'ci-dev-aks-tests'
- name: AMW_QUERY_ENDPOINT
  displayName: 'AMW Query Endpoint'
  type: string
  default: 'https://ci-dev-aks-tests-amw-fcdqc5d4agbyh9en.centralus.prometheus.monitor.azure.com'
- name: AZURE_CLIENT_ID
  displayName: 'Azure Client ID'
  type: string
  default: 'f8b1889c-310c-4913-93c5-3faf0f594f34'
- name: branch
  displayName: 'Branch to run tests from'
  type: string
  default: 'main'

variables:
  HELM_CHART_NAME: 'prometheus-collector'
  ACR_REGISTRY: 'containerinsightsprod.azurecr.io'
  ACR_REPOSITORY: '/public/azuremonitor/containerinsights/cidev/prometheus-collector/images'
  ACR_REPOSITORY_HELM: '/public/azuremonitor/containerinsights/cidev'
  MCR_REGISTRY: 'mcr.microsoft.com'
  MCR_REPOSITORY: '/azuremonitor/containerinsights/cidev/prometheus-collector/images'
  MCR_REPOSITORY_HELM: '/azuremonitor/containerinsights/cidev/prometheus-collector'
  MCR_REPOSITORY_HELM_DEPENDENCIES: '/azuremonitor/containerinsights/cidev'
  BUILD_WINDOWS: true
  Codeql.Enabled: true
  GOLANG_VERSION: '1.24.9'
  TESTKUBE_GOLANG_VERSION: '1.23.10'
  FLUENT_BIT_VERSION: '3.2.2'

stages:
- stage: Deploy
  jobs:
  - deployment: Testkube
    displayName: "Test: AKS testkube tests"
    environment: Prometheus-Collector-Tests
    timeoutInMinutes: 360
    pool:
      name: Azure-Pipelines-CI-Test-EO
      image: ci-1es-managed-ubuntu-2204
      os: linux
    condition: succeeded()
    variables:
      skipComponentGovernanceDetection: true
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            persistCredentials: true

          - bash: |
              curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              chmod +x kubectl
              sudo mv kubectl /usr/local/bin/

              exit 0
            workingDirectory: $(Build.SourcesDirectory)
            displayName: "Install kubectl CLI"

          - bash: |
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

              exit 0
            workingDirectory: $(Build.SourcesDirectory)
            displayName: "Install Azure CLI"

          - task: AzureCLI@2
            displayName: Get kubeconfig
            inputs:
                scriptType: 'bash'
                azureSubscription: ${{ parameters.subscriptionName }}(${{ parameters.subscriptionID }})
                scriptLocation: 'inlineScript'
                inlineScript: 'az aks get-credentials -g ${{ parameters.clusterResourceGroup }} -n ${{ parameters.clusterName }}'
          
          - bash: |
              # Delete all the configmaps to test the no configmaps case
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-settings-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-windows-configmap.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-no-configmaps-crs.yaml" \
                "testkube-config-test-no-configmaps-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for no configmaps"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-all-targets-disabled.yaml
              
              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-all-targets-disabled-crs.yaml" \
                "testkube-config-test-all-targets-disabled-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for all targets disabled"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-defaults-targets-turned-on.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-default-targets-on-crs.yaml" \
                "testkube-config-test-default-targets-on-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for all default targets in settings cfg map enabled"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-rs-targets-enabled.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-all-rs-targets-enabled-crs.yaml" \
                "testkube-config-test-all-rs-targets-enabled-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for all rs targets in settings cfg map enabled"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-ds-targets-enabled.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-all-ds-targets-enabled-crs.yaml" \
                "testkube-config-test-all-ds-targets-enabled-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for all ds targets in settings cfg map enabled"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-all-targets-enabled.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-all-targets-enabled-crs.yaml" \
                "testkube-config-test-all-targets-enabled-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for all targets in settings cfg map enabled"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-settings-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-windows-configmap.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-defaults-targets-turned-on.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/custom-config-map/ama-metrics-prometheus-config-configmap-all-actions.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-only-custom-configmap-crs.yaml" \
                "testkube-config-test-only-custom-configmap-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for custom configmap with all actions enabled"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-configmap.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-global-settings-crs.yaml" \
                "testkube-config-test-global-settings-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for global ext labels enabled"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/custom-config-map/ama-metrics-prometheus-config-configmap-all-actions.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-configmap.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-windows-configmap.yaml
              
              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-custom-node-configmap-crs.yaml" \
                "testkube-config-test-custom-node-configmap-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for custom node configmap enabled"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-windows-configmap.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-error.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-settings-error-crs.yaml" \
                "testkube-config-test-settings-error-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for errorprone settings configmap"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-defaults-targets-turned-on.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/custom-config-map/ama-metrics-prometheus-config-configmap-with-error.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/custom-config-map-node/ama-metrics-prometheus-config-node-configmap-errors.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/custom-config-map-win/ama-metrics-prometheus-config-node-windows-configmap-errors.yaml
              
              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-custom-configmap-error-crs.yaml" \
                "testkube-config-test-custom-configmap-error-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for errorprone custom configmap"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              kubectl apply -f ./test-cluster-yamls/configmaps/default-config-map/ama-metrics-settings-configmap-defaults-targets-turned-on.yaml
              kubectl apply -f ./test-cluster-yamls/configmaps/global-settings/ama-metrics-prometheus-config-configmap-with-global-error.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-global-ext-labels-error-crs.yaml" \
                "testkube-config-test-global-ext-labels-error-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for errorprone global ext labels"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              # Remove any leftover custom Prometheus configmaps first
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-configmap.yaml
              kubectl delete -f ./test-cluster-yamls/configmaps/ama-metrics-prometheus-config-node-windows-configmap.yaml

              export BUILD_ARTIFACTSTAGINGDIRECTORY="$(Pipeline.Workspace)"
              export BUILD_BUILDID="$(Build.BuildId)"
              export SYSTEM_JOBID="$(System.JobId)"
              export SYSTEM_TASKINSTANCEID="$(System.TaskInstanceId)"

              chmod +x ./testkube/run-testkube-workflow.sh
              ./testkube/run-testkube-workflow.sh \
                "${{ parameters.AMW_QUERY_ENDPOINT }}" \
                "${{ parameters.AZURE_CLIENT_ID }}" \
                "testkube-config-test-default-targets-on-v2-crs.yaml" \
                "testkube-config-test-default-targets-on-v2-crs.yaml" \
                "false" \
                "480" \
                "ConfigTests" \
                "${{ parameters.branch }}"
            workingDirectory: $(Build.SourcesDirectory)/otelcollector/test
            displayName: "Run tests for all default targets in settings cfg map enabled (v2)"
            continueOnError: true

          - bash: |
              RESULTS_FILE="$(Pipeline.Workspace)/testkube-results-ConfigTests.json"

              if [ -f "$RESULTS_FILE" ]; then
                echo "Results file exists: $RESULTS_FILE"
                echo "Contents of results file:"
                cat "$RESULTS_FILE"
              else
                echo "Results file not found: $RESULTS_FILE"
              fi
            displayName: "Create TestKube Results Summary"
            condition: always()

          - bash: |
              if [ -f "$(Pipeline.Workspace)/testkube-results-ConfigTests.json" ]; then
                # Read the JSON content and set it as a pipeline variable
                TESTKUBE_RESULTS_CONFIG=$(cat "$(Pipeline.Workspace)/testkube-results-ConfigTests.json" | jq -c . | tr -d '\n\r')
                echo "##vso[task.setvariable variable=TESTKUBE_RESULTS_CONFIG;isOutput=true]$TESTKUBE_RESULTS_CONFIG"
                echo "TestKube Config tests results set as pipeline variable"
                echo $TESTKUBE_RESULTS_CONFIG
              else
                echo "##vso[task.setvariable variable=TESTKUBE_RESULTS_CONFIG;isOutput=true]{\"environment\":\"ConfigTests\",\"status\":\"failed\",\"message\":\"Results file not found\"}"
                echo "TestKube Config tests results file not found, setting default failure result"
              fi
            displayName: "Set TestKube Config Results as Pipeline Variable"
            condition: always()
            name: testkube_results

  - job: TestKube_Summary
    displayName: "Send TestKube Summary Notification"
    pool:
      name: Azure-Pipelines-CI-Test-EO
    dependsOn: Testkube
    condition: always()
    variables:
      skipComponentGovernanceDetection: true
      TESTKUBE_RESULTS_CONFIG: $[ dependencies.Testkube.outputs['Testkube.testkube_results.TESTKUBE_RESULTS_CONFIG'] ]
    steps:
    - checkout: self
      persistCredentials: true

    - bash: |
        # Create results directory
        mkdir -p "$(Pipeline.Workspace)/testkube-results"
        echo "Results directory created"
      displayName: "Create TestKube Results Directory"

    # Write Config tests results directly to file if available using PowerShell
    - task: PowerShell@2
      displayName: "Write Config Tests Results"
      condition: and(succeeded(), ne(variables['TESTKUBE_RESULTS_CONFIG'], ''))
      env:
        TESTKUBE_RESULTS: $(TESTKUBE_RESULTS_CONFIG)
      inputs:
        targetType: 'inline'
        script: |
          $content = $env:TESTKUBE_RESULTS
          Set-Content -Path "$(Pipeline.Workspace)/testkube-results/testkube-results-ConfigTests.json" -Value $content

    # List created files
    - bash: |
        echo "Results files created:"
        ls -la "$(Pipeline.Workspace)/testkube-results/"
      displayName: "List Results Files"

    - bash: |
        export SYSTEM_PULLREQUEST_PULLREQUESTTITLE="$(System.PullRequest.PullRequestTitle)"
        export SYSTEM_PULLREQUEST_PULLREQUESTNUMBER="$(System.PullRequest.PullRequestNumber)"
        export BUILD_REASON="$(Build.Reason)"
        export BUILD_SOURCEVERSIONMESSAGE="$(Build.SourceVersionMessage)"
        export BUILD_SOURCEBRANCHNAME="$(Build.SourceBranchName)"
        export BUILD_BUILDNUMBER="$(Build.BuildNumber)"
        chmod +x ./otelcollector/test/testkube/send-testkube-summary.sh
        ./otelcollector/test/testkube/send-testkube-summary.sh $(TEAMS_WEBHOOK_URL) $(Pipeline.Workspace)/testkube-results
      workingDirectory: $(Build.SourcesDirectory)
      displayName: "Send TestKube Summary Notification"