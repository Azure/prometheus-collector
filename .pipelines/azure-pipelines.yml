# Go to https://github-private.visualstudio.com/microsoft/_build?definitionId=405 and manually run the pipeline for CG detection
# Then find the results here: https://github-private.visualstudio.com/microsoft/_componentGovernance/188700
trigger: none

variables:
  #WindowsContainerImage: cdpxwin1809.azurecr.io/global/vse2019:latest # for Windows jobs
  LinuxContainerImage: onebranch.azurecr.io/linux/ubuntu-2004:latest # for Linux jobs
  tag: '$(Build.BuildId)'

resources:
  repositories: 
    - repository: templates
      type: git
      name: OneBranch.Pipelines/GovernedTemplates
      ref: refs/heads/main
    - repository: self

extends:
  template: v2/OneBranch.Official.CrossPlat.yml@templates
  parameters:
    stages:
    - stage: build
      jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: ubuntu-latest
        steps:
        - script: |
            sudo apt-get install build-essential -y
          displayName: 'Get build dependencies'
        - script: |
            cd $(Build.SourcesDirectory)/otelcollector/opentelemetry-collector-builder/ && make
          displayName: 'make'
        - task: Docker@2
          displayName: Build an image
          inputs:
            command: build
            dockerfile: '$(Build.SourcesDirectory)/otelcollector/Dockerfile'
            tags: |
              $(tag)
