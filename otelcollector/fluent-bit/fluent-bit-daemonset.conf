[SERVICE]
    Flush         15
    HTTP_Server   Off
    Daemon        Off
    storage.path  /var/opt/microsoft/state/flbstore/
    storage.sync  normal
    storage.checksum off
    storage.backlog.mem_limit 10M
    Log_Level     debug
    Parsers_File  /opt/fluent-bit/fluent-bit-parsers.conf
    Log_File      /opt/fluent-bit/fluent-bit.log


[INPUT]
    Name exec
    Command top -bn 1 | grep [/]opt/microsoft/otelcollector/otelcollector | awk "{printf \"%.1f\", \$8}"
    Tag           exec.cpu.otelcollector
    Interval_Sec 10
    Interval_NSec 0

[INPUT]
    Name exec
    Command top -bn 1 | grep [/]usr/sbin/MetricsExtension | awk "{printf \"%.1f\", \$8}"
    Tag           exec.cpu.metricsextension
    Interval_Sec 10
    Interval_NSec 0

[OUTPUT]
    Name file
    Match exec.cpu.otelcollector
    Path /opt/fluent-bit
    File execotelcollector.log

[OUTPUT]
    Name file
    Match exec.cpu.metricsextension
    Path /opt/fluent-bit
    File execmetricsextension.log

[INPUT]
    Name tail
    Path /opt/fluent-bit/execotelcollector.log
    Read_from_Head true
    Tag cpu.otelcollector
    Parser exec-parser
    Mem_Buf_Limit 1m
    Path_Key filepath
    Skip_Long_Lines On
    Ignore_Older 2m

[INPUT]
    Name tail
    Path /opt/fluent-bit/execmetricsextension.log
    Read_from_Head true
    Tag cpu.metricsextension
    Parser exec-parser
    Mem_Buf_Limit 1m
    Path_Key filepath
    Skip_Long_Lines On
    Ignore_Older 2m

[OUTPUT]
    Name                            appinsights
    Match                           cpu.otelcollector

[OUTPUT]
    Name                            appinsights
    Match                           cpu.metricsextension
