apiVersion: tests.testkube.io/v3
kind: Test
metadata:
  name: containerstatus
  namespace: testkube
  labels:
    executor: ginkgo-executor
    test-type: ginkgo-test
spec:
  type: ginkgo/test
  content:
    type: git
    repository:
      type: git
      uri: https://github.com/Azure/prometheus-collector
      branch: main
      path: otelcollector/test
  executionRequest:
    args:
      - "--label-filter"
      - "!(arc-extension,linux-daemonset-custom-config)"
      - "./containerstatus"
    executePostRunScriptBeforeScraping: false
---
apiVersion: tests.testkube.io/v3
kind: Test
metadata:
  name: livenessprobe
  namespace: testkube
  labels:
    executor: ginkgo-executor
    test-type: ginkgo-test
spec:
  type: ginkgo/test
  content:
    type: git
    repository:
      type: git
      uri: https://github.com/Azure/prometheus-collector
      branch: main
      path: otelcollector/test
  executionRequest:
    args:
      - "--label-filter"
      - "!(arc-extension,linux-daemonset-custom-config)"
      - "./livenessprobe"
    executePostRunScriptBeforeScraping: false
---
apiVersion: tests.testkube.io/v3
kind: Test
metadata:
  name: prometheusui
  namespace: testkube
  labels:
    executor: ginkgo-executor
    test-type: ginkgo-test
spec:
  type: ginkgo/test
  content:
    type: git
    repository:
      type: git
      uri: https://github.com/Azure/prometheus-collector
      branch: main
      path: otelcollector/test
  executionRequest:
    args:
      - "--label-filter"
      - "!(arc-extension,linux-daemonset-custom-config)"
      - "./prometheusui"
    executePostRunScriptBeforeScraping: false
---
apiVersion: tests.testkube.io/v3
kind: Test
metadata:
  name: operator
  namespace: testkube
  labels:
    executor: ginkgo-executor
    test-type: ginkgo-test
spec:
  type: ginkgo/test
  content:
    type: git
    repository:
      type: git
      uri: https://github.com/Azure/prometheus-collector
      branch: main
      path: otelcollector/test
  executionRequest:
    args:
      - "--ldflags"
      - "-s -X github.com/prometheus-operator/prometheus-operator/pkg/apis/monitoring.GroupName=azmonitoring.coreos.com"
      - "./operator"
    executePostRunScriptBeforeScraping: false
---
apiVersion: tests.testkube.io/v3
kind: Test
metadata:
  name: querymetrics
  namespace: testkube
  labels:
    executor: ginkgo-executor
    test-type: ginkgo-test
spec:
  type: ginkgo/test
  content:
    type: git
    repository:
      type: git
      uri: https://github.com/Azure/prometheus-collector
      branch: main
      path: otelcollector/test
  executionRequest:
    args:
      - "--label-filter"
      - "!(arc-extension,linux-daemonset-custom-config)"
      - "./querymetrics"
    executePostRunScriptBeforeScraping: false
    variables:
      AMW_QUERY_ENDPOINT:
        name: AMW_QUERY_ENDPOINT
        type: secret
        valueFrom:
          secretKeyRef:
            name: querymetrics-testvars
            key: AMW_QUERY_ENDPOINT
      QUERY_ACCESS_CLIENT_ID:
        name: QUERY_ACCESS_CLIENT_ID
        type: secret
        valueFrom:
          secretKeyRef:
            name: querymetrics-testvars
            key: QUERY_ACCESS_CLIENT_ID
      QUERY_ACCESS_TOKEN_SECRET:
        name: QUERY_ACCESS_CLIENT_SECRET
        type: secret
        valueFrom:
          secretKeyRef:
            name: querymetrics-testvars
            key: QUERY_ACCESS_CLIENT_SECRET
---
apiVersion: tests.testkube.io/v3
kind: TestSuite
metadata:
  name: e2e-tests-nightly
  namespace: testkube
spec:
  steps:
  - stopOnFailure: false
    execute:
    - test: containerstatus
    - test: prometheusui
    - test: operator
  - stopOnFailure: false
    execute:
    - delay: 2m0s
  - stopOnFailure: false
    execute:
    - test: querymetrics
  - stopOnFailure: false
    execute:
    - test: livenessprobe
  schedule: "0 7 * * *"
---
apiVersion: tests.testkube.io/v3
kind: TestSuite
metadata:
  name: e2e-tests-merge
  namespace: testkube
spec:
  steps:
  - stopOnFailure: false
    execute:
    - test: containerstatus
    - test: prometheusui
    - test: operator
  - stopOnFailure: false
    execute:
    - delay: 2m0s
  - stopOnFailure: false
    execute:
    - test: querymetrics
