{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {},
    "variables": {},
    "resources": [
        {
            "name": "$name",
            "type": "Microsoft.AlertsManagement/prometheusRuleGroups",
            "apiVersion": "2021-07-22-preview",
            "location": "$MACLocation",
            "properties": {
                "description": "rule group for cluster $cluster",
                "scopes": [
                    "$mac"
                ],
                "interval": "PT5M",
                "rules": [
                    {
                        "alert": "Average CPU usage per container is greater than 95%",
                        "expression": "sum (rate(container_cpu_usage_seconds_total{cluster = \"$cluster\",name!~\".*prometheus.*\", image!=\"\", container_name!=\"POD\"}[5m])) by (pod_name, container,cluster,namespace) / sum(container_spec_cpu_quota{cluster = \"$cluster\",name!~\".*prometheus.*\", image!=\"\", container_name!=\"POD\"}/container_spec_cpu_period{cluster = \"$cluster\",name!~\".*prometheus.*\", image!=\"\", container_name!=\"POD\"}) by (pod_name, container,cluster,namespace) >.95",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Average CPU usage per container is greater than 95%"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Average CPU usage for container is greater than 95% in cluster: {{$labels.cluster}} for container: {{$labels.container}}"

                                }
                            }
                        ]
                    },
                    {
                        "alert": "Average Memory usage per container is greater than 95%.",
                        "expression": "sum by (namespace,cluster,container) (container_memory_working_set_bytes{cluster = \"$cluster\", container!=\"\", image!=\"\", container_name!=\"POD\"}) / sum by (namespace,cluster,container) (kube_pod_container_resource_limits{cluster = \"$cluster\", resource=\"memory\"}) > .95 ",
                        "for": "PT10M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Average Memory usage per container is greater than 95%"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT10M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Average Memory usage per container is greater than 95% in cluster: {{$labels.cluster}} for container: {{$labels.container}}"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Number of OOM killed containers is greater than 0",
                        "expression": "sum by (cluster,container,namespace)(kube_pod_container_status_last_terminated_reason{reason=\"OOMKilled\",cluster=\"$cluster\"}) > 0",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Number of OOM killed containers is greater than 0"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT10M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Number of OOM killed containers is greater than 0 in cluster: {{$labels.cluster}} for container: {{$labels.container}}"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Average PV usage is greater than 80%",
                        "expression": "sum by (namespace,cluster,container,pod)(kubelet_volume_stats_used_bytes{job=\"kubelet\", cluster=\"$cluster\"}) / sum by (namespace,cluster,container,pod)(kubelet_volume_stats_capacity_bytes{job=\"kubelet\", cluster=\"$cluster\"})  >.8",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Average PV usage is greater than 80%"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Average PV usage is greater than 80% in cluster: {{$labels.cluster}} in pod: {{$labels.pod}} in container: {{$labels.container}}"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Pod container restarted in last 1 hour",
                        "expression": "sum by (namespace, pod, container, cluster) (kube_pod_container_status_restarts_total{job=\"kube-state-metrics\", cluster= \"$cluster\", namespace=\"kube-system\"}) > 0 ",
                        "for": "PT15M", 
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Pod container restarted in last 1 hour"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT10M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Pod container restarted in last 1 hour in cluster: {{$labels.cluster}} in pod: {{$labels.pod}} in container: {{$labels.container}}"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Node is not ready.",
                        "expression": "sum by (namespace,cluster,node)(kube_node_status_condition{cluster=\"$cluster\",job=\"kube-state-metrics\",condition=\"Ready\",status!=\"true\", node!=\"\"}) > 0",
                        "for": "PT15M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Node has been unready for more than 15 minutes "
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Node {{$labels.node}} is not ready in cluster: {{$labels.cluster}}"

                                }
                            }
                        ]
                    },
                    {
                        "alert": "Ready state of pods is less than 80%. ",
                        "expression": "sum by (cluster,namespace,deployment)(kube_deployment_status_replicas_ready {cluster=\"$cluster\"}) / sum by (cluster,namespace,deployment)(kube_deployment_spec_replicas {cluster=\"$cluster\"}) <.8 or sum by (cluster,namespace,deployment)(kube_daemonset_status_number_ready{cluster=\"$cluster\"}) / sum by (cluster,namespace,deployment)(kube_daemonset_status_desired_number_scheduled{cluster=\"$cluster\"}) <.8 ",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Ready state of pods is less than 80%."
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Ready state of pods is less than 80% in cluster: {{$labels.cluster}} in deployment: {{$labels.deployment}}"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Job did not complete in time",
                        "expression": "sum by(namespace,cluster)(kube_job_spec_completions{job=\"kube-state-metrics\",cluster=\"$cluster\"}) - sum by(namespace,cluster)(kube_job_status_succeeded{job=\"kube-state-metrics\",cluster=\"$cluster\"})  > 0 ",
                        "for": "PT360M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Number of stale jobs older than six hours is greater than 0"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Number of stale jobs older than six hours is greater than 0 in cluster: {{$labels.cluster}}"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Average node CPU utilization is greater than 80%",
                        "expression": "(  (1 - rate(node_cpu_seconds_total{job=\"node\", mode=\"idle\",cluster=\"$cluster\"}[5m]) ) / ignoring(cpu) group_left count without (cpu)( node_cpu_seconds_total{job=\"node\", mode=\"idle\",cluster=\"$cluster\"}) ) > .8 ",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Average node CPU utilization is greater than 80%"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Average node CPU utilization is greater than 80% in cluster: {{$labels.cluster}} in node: {{$labels.instance}}"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Working set memory for a node is greater than 80%.",
                        "expression": "1 - avg by (namespace,cluster,job)(node_memory_MemAvailable_bytes{job=\"node\",cluster=\"$cluster\"}) / avg by (namespace,cluster,job)(node_memory_MemTotal_bytes{job=\"node\",cluster=\"$cluster\"}) > .8",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Working set memory for a node is greater than 80%."
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Working set memory for a node is greater than 80% in cluster: {{$labels.cluster}} in node: {{$labels.instance}}"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Number of pods in failed state are greater than 0.",
                        "expression": "sum by (cluster, namespace, pod) (kube_pod_status_phase{cluster=\"$cluster\",phase=\"failed\"}) > 0",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "$cluster"
                        },
                        "annotations": {
                            "description": "Number of pods in failed state are greater than 0"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True",
                                    "Icm.Title": "Number of pods in failed state are greater than 0 in cluster: {{$labels.cluster}} pod: {{$labels.pod}}"
                                }
                            }
                        ]
                    }  
                ]
            }
        }
    ]
}