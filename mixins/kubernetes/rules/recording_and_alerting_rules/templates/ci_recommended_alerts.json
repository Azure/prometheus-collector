{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {},
    "variables": {},
    "resources": [
        {
            "name": "containerinsightsprodclusteraccount_alerts",
            "type": "Microsoft.AlertsManagement/prometheusRuleGroups",
            "apiVersion": "2021-07-22-preview",
            "location": "eastus2euap",
            "properties": {
                "description": "rule group for cluster sohamcluster",
                "scopes": [
                    "/subscriptions/ce4d1293-71c0-4c72-bc55-133553ee9e50/resourcegroups/sohamTestKV/providers/microsoft.monitor/accounts/sohamtest3"
                ],
                "interval": "PT5M",
                "rules": [
                    {
                        "alert": "Average CPU usage per container is greater than 95%",
                        "expression": "sum (rate(container_cpu_usage_seconds_total{cluster = \"sohamcluster\",name!~\".*prometheus.*\", image!=\"\", container_name!=\"POD\"}[5m])) by (pod_name, container,cluster,namespace) / sum(container_spec_cpu_quota{cluster = \"sohamcluster\",name!~\".*prometheus.*\", image!=\"\", container_name!=\"POD\"}/container_spec_cpu_period{cluster = \"sohamcluster\",name!~\".*prometheus.*\", image!=\"\", container_name!=\"POD\"}) by (pod_name, container,cluster,namespace) >1.2",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Average CPU usage per container is greater than 95%"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Average Memory usage per container is greater than 95%.",
                        "expression": "sum by (namespace,cluster,container) (container_memory_working_set_bytes{cluster = \"sohamcluster\", container!=\"\", image!=\"\", container_name!=\"POD\"}) / sum by (namespace,cluster,container) (kube_pod_container_resource_limits{cluster = \"sohamcluster\", resource=\"memory\"}) > 1.2",
                        "for": "PT10M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Average Memory usage per container is greater than 95%"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT10M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Number of OOM killed containers is greater than 0",
                        "expression": "sum by (cluster,container,namespace)(kube_pod_container_status_last_terminated_reason{reason=\"OOMKilled\",cluster=\"sohamcluster\"}) > 1000",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Number of OOM killed containers is greater than 0"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT10M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Average PV usage is greater than 80%",
                        "expression": "sum by (namespace,cluster,container,pod)(kubelet_volume_stats_used_bytes{job=\"kubelet\", cluster=\"sohamcluster\"}) / sum by (namespace,cluster,container,pod)(kubelet_volume_stats_capacity_bytes{job=\"kubelet\", cluster=\"sohamcluster\"})  >1.2",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Average PV usage is greater than 80%"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Pod container restarted in last 1 hour",
                        "expression": "sum by (namespace, pod, container, cluster) (kube_pod_container_status_restarts_total{job=\"kube-state-metrics\", cluster= \"sohamcluster\", namespace=\"kube-system\"}) > 1000 ",
                        "for": "PT15M", 
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Pod container restarted in last 1 hour"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT10M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Node is not ready.",
                        "expression": "sum by (namespace,cluster,node)(kube_node_status_condition{cluster=\"sohamcluster\",job=\"kube-state-metrics\",condition=\"Ready\",status!=\"true\", node!=\"\"}) > 1000",
                        "for": "PT15M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Node has been unready for more than 15 minutes "
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Ready state of pods is less than 80%. ",
                        "expression": "sum by (cluster,namespace,deployment)(kube_deployment_status_replicas_ready {cluster=\"sohamcluster\"}) / sum by (cluster,namespace,deployment)(kube_deployment_spec_replicas {cluster=\"sohamcluster\"}) >1 or sum by (cluster,namespace,deployment)(kube_daemonset_status_number_ready{cluster=\"sohamcluster\"}) / sum by (cluster,namespace,deployment)(kube_daemonset_status_desired_number_scheduled{cluster=\"sohamcluster\"}) >1",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Ready state of pods is less than 80%."
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Job did not complete in time",
                        "expression": "sum by(namespace,cluster)(kube_job_spec_completions{job=\"kube-state-metrics\",cluster=\"sohamcluster\"}) - sum by(namespace,cluster)(kube_job_status_succeeded{job=\"kube-state-metrics\",cluster=\"sohamcluster\"})  > 1000 ",
                        "for": "PT360M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Number of stale jobs older than six hours is greater than 0"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Average node CPU utilization is greater than 80%",
                        "expression": "(  (1 - rate(node_cpu_seconds_total{job=\"node\", mode=\"idle\",cluster=\"sohamcluster\"}[5m]) ) / ignoring(cpu) group_left count without (cpu)( node_cpu_seconds_total{job=\"node\", mode=\"idle\",cluster=\"sohamcluster\"}) ) > 1.2 ",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Average node CPU utilization is greater than 80%"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Working set memory for a node is greater than 80%.",
                        "expression": "1 - avg by (namespace,cluster,job)(node_memory_MemAvailable_bytes{job=\"node\",cluster=\"sohamcluster\"}) / avg by (namespace,cluster,job)(node_memory_MemTotal_bytes{job=\"node\",cluster=\"sohamcluster\"}) > 1.2",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Working set memory for a node is greater than 80%."
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    },
                    {
                        "alert": "Number of pods in failed state are greater than 0.",
                        "expression": "sum by (cluster, namespace, pod) (kube_pod_status_phase{cluster=\"sohamcluster\",phase=\"failed\"}) > 1000",
                        "for": "PT5M",
                        "labels": {
                            "cluster": "sohamcluster"
                        },
                        "annotations": {
                            "description": "Number of pods in failed state are greater than 0"
                        },
                        "severity": 4,
                        "resolveConfiguration": {
                            "autoResolved": true,
                            "timeToResolve": "PT15M"
                        },
                        "actions": [
                            {
                                "ActionProperties": {
                                    "Icm.Enabled": "True"
                                }
                            }
                        ]
                    }  
                ]
            }
        }
    ]
}
